<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KreditLab Pipeline App</title>
  <style>
    :root {
      --bg: #edf4ff;
      --surface: #ffffff;
      --surface-soft: #f4f8ff;
      --text: #111a2d;
      --muted: #58667f;
      --primary: #0a3d91;
      --primary-2: #2d6cdf;
      --accent: #00b7d4;
      --success: #148a52;
      --danger: #cf2642;
      --warning: #b7791f;
      --border: #d7e4fb;
      --ring: rgba(45, 108, 223, 0.2);
      --shadow: 0 16px 34px rgba(16, 38, 84, 0.1);
    }

    [data-theme="dark"] {
      --bg: #030816;
      --surface: #0c1427;
      --surface-soft: #111d35;
      --text: #e2ecff;
      --muted: #93a8c8;
      --primary: #3f88ff;
      --primary-2: #00b7d4;
      --accent: #4ce2ff;
      --success: #2bd37f;
      --danger: #ff5572;
      --warning: #ffbd59;
      --border: #1f3358;
      --ring: rgba(76, 226, 255, 0.2);
      --shadow: 0 24px 44px rgba(1, 6, 19, 0.64);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Manrope", Inter, "Segoe UI", Arial, sans-serif;
      background:
        radial-gradient(circle at 2% 0%, rgba(45,108,223,.2), transparent 32%),
        radial-gradient(circle at 102% -4%, rgba(0,183,212,.2), transparent 28%),
        linear-gradient(180deg, rgba(255,255,255,.35), rgba(255,255,255,0)),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 26px;
    }

    .shell {
      max-width: 1320px;
      margin: 0 auto;
    }

    .app-header {
      background: linear-gradient(125deg, color-mix(in srgb, var(--surface) 86%, var(--accent) 14%), var(--surface-soft));
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px 22px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .brand img {
      height: 42px;
      border-radius: 10px;
      background: rgba(255,255,255,.86);
      padding: 4px 8px;
    }

    .brand-text h1 {
      margin: 0;
      font-size: 1.25rem;
      letter-spacing: .2px;
    }

    .brand-text p {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: .9rem;
    }

    .theme-btn {
      border: 1px solid var(--border);
      color: var(--text);
      background: linear-gradient(145deg, var(--surface), var(--surface-soft));
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
    }

    .layout {
      display: grid;
      gap: 18px;
      grid-template-columns: 420px minmax(0, 1fr);
      align-items: start;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 20px;
      box-shadow: var(--shadow);
    }

    .title {
      margin: 0;
      font-size: 1.1rem;
    }

    .subtitle {
      margin: 8px 0 16px;
      color: var(--muted);
      font-size: .92rem;
      line-height: 1.45;
    }

    .field { margin-bottom: 12px; }
    .field label { font-size: .9rem; color: var(--muted); }

    .input, .token-input {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 11px 12px;
      margin-top: 6px;
      background: var(--surface-soft);
      color: var(--text);
      outline: none;
    }

    .input:focus, .token-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--ring);
    }

    .check-wrap {
      margin: 8px 0 14px;
      color: var(--muted);
      font-size: .9rem;
    }

    .stage-list { display: grid; gap: 8px; margin: 14px 0 16px; }

    .stage {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: .9rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--surface-soft);
    }

    .pill {
      padding: 4px 9px;
      border-radius: 999px;
      background: color-mix(in srgb, var(--surface-soft) 70%, var(--border) 30%);
      color: var(--muted);
      text-transform: capitalize;
      font-size: .8rem;
      font-weight: 600;
    }

    .pill.success { background: color-mix(in srgb, var(--success) 22%, var(--surface)); color: var(--success); }
    .pill.error { background: color-mix(in srgb, var(--danger) 22%, var(--surface)); color: var(--danger); }
    .pill.running { background: color-mix(in srgb, var(--primary) 20%, var(--surface)); color: var(--primary); }

    .btn {
      width: 100%;
      border: none;
      border-radius: 12px;
      color: #fff;
      font-weight: 700;
      padding: 11px;
      cursor: pointer;
      margin-top: 8px;
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      box-shadow: 0 10px 22px color-mix(in srgb, var(--primary) 26%, transparent);
    }

    .btn.secondary { background: linear-gradient(135deg, #1d2e4b, #284264); }
    .btn:disabled { opacity: .5; cursor: not-allowed; }

    .status {
      margin-top: 14px;
      min-height: 20px;
      font-size: .9rem;
      color: var(--muted);
      font-weight: 600;
    }

    .status.success { color: var(--success); }
    .status.error { color: var(--danger); }

    .results-title {
      margin: 18px 0 8px;
      font-size: .92rem;
      color: var(--muted);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .08em;
    }

    .result-item {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 11px;
      margin-top: 8px;
      background: var(--surface-soft);
    }

    .result-actions { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }

    .result-actions button {
      border: 1px solid var(--border);
      background: linear-gradient(145deg, var(--surface), var(--surface-soft));
      color: var(--text);
      border-radius: 9px;
      padding: 6px 9px;
      cursor: pointer;
      font-weight: 600;
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    iframe {
      width: 100%;
      min-height: 780px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
    }

    @media (max-width: 1080px) {
      .layout { grid-template-columns: 1fr; }
      iframe { min-height: 560px; }
      body { padding: 18px; }
      .app-header { padding: 15px; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="app-header">
      <div class="brand">
        <img id="brandLogo" src="/assets/KreditLab-light.png" alt="KreditLab logo" />
        <div class="brand-text">
          <h1>KreditLab Financial Statement Workspace</h1>
      <p>KreditLab-style workspace for extraction, AI transform (Sonnet 4.6), and export-ready report rendering.</p>
        </div>
      </div>
      <button id="themeToggle" class="theme-btn" type="button">ðŸŒ™ Dark mode</button>
    </header>

    <div class="layout">
      <section class="card">
        <h2 class="title">Pipeline Controls</h2>
        <p class="subtitle">Upload one or more PDFs and run each stage in sequence. Stage status and output files will appear below.</p>

        <div class="field">
          <label for="token">Bearer token (optional)</label>
          <input id="token" class="token-input" placeholder="Paste APP_TOKEN if required" />
        </div>

        <div class="field">
          <label for="pdfFiles">Choose PDF files</label>
          <input id="pdfFiles" class="input" type="file" accept="application/pdf" multiple />
        </div>

        <label class="check-wrap"><input id="includePdf" type="checkbox" /> Include generated PDF output</label>

        <div class="stage-list">
          <div class="stage"><span>1) Tensorlake extraction</span><span id="stage1" class="pill">pending</span></div>
          <div class="stage"><span>2) API transform (Sonnet 4.6)</span><span id="stage2" class="pill">pending</span></div>
          <div class="stage"><span>3) HTML rendering</span><span id="stage3" class="pill">pending</span></div>
        </div>

        <button id="runStage1Btn" class="btn">Start Stage 1 (Tensorlake)</button>
        <button id="runStage2Btn" class="btn secondary" disabled>Proceed Stage 2 (API Transform)</button>
        <button id="runStage3Btn" class="btn secondary" disabled>Proceed Stage 3 (HTML Render)</button>

        <div id="status" class="status"></div>
        <div class="results-title">Results</div>
        <div id="results"></div>
      </section>

      <section class="card">
        <div class="preview-header">
          <h3 style="margin:0;">Live HTML Preview</h3>
          <span id="previewLabel" class="pill">No file selected</span>
        </div>
        <iframe id="preview"></iframe>
      </section>
    </div>
  </div>

<script>
const statusEl = document.getElementById('status');
const preview = document.getElementById('preview');
const resultsEl = document.getElementById('results');
const previewLabel = document.getElementById('previewLabel');
const themeToggle = document.getElementById('themeToggle');
const brandLogo = document.getElementById('brandLogo');

const stageState = { extracted: [], transformed: [], rendered: [] };

function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  const dark = theme === 'dark';
  brandLogo.src = dark ? '/assets/KreditLab-dark.png' : '/assets/KreditLab-light.png';
  themeToggle.textContent = dark ? 'â˜€ï¸ Light mode' : 'ðŸŒ™ Dark mode';
  localStorage.setItem('kreditlab-theme', theme);
}

const savedTheme = localStorage.getItem('kreditlab-theme') || 'light';
applyTheme(savedTheme);
themeToggle.addEventListener('click', () => applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));

function collectStageErrors(items) {
  return (items || []).filter(item => item.status === 'error').map(item => `${item.filename || 'unknown file'}: ${item.error || 'Unknown error'}`);
}

function renderStageErrors(title, items) {
  const errors = collectStageErrors(items);
  if (!errors.length) return;
  const row = document.createElement('div');
  row.className = 'result-item';
  row.innerHTML = `<div><strong>${title}</strong></div>`;

  const list = document.createElement('ul');
  list.style.margin = '8px 0 0 18px';
  list.style.padding = '0';
  errors.forEach((errorLine) => {
    const li = document.createElement('li');
    li.style.color = '#dc2626';
    li.style.fontSize = '.84rem';
    li.textContent = errorLine;
    list.appendChild(li);
  });

  row.appendChild(list);
  resultsEl.prepend(row);
}

function authHeaders(extra = {}) {
  const token = document.getElementById('token').value.trim();
  return token ? { ...extra, Authorization: `Bearer ${token}` } : extra;
}

function setStage(id, state) {
  const el = document.getElementById(id);
  el.className = `pill ${state}`;
  el.textContent = state;
}

function setStatus(message, isError = false) {
  statusEl.className = `status ${isError ? 'error' : 'success'}`;
  statusEl.textContent = message;
}

function fileStem(filename) { return filename.replace(/\.[^.]+$/, '') || 'report'; }

function downloadTextFile(filename, content, mime) {
  const blob = new Blob([content], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 500);
}

function downloadPdfBase64(filename, base64) {
  const bin = atob(base64);
  const arr = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i += 1) arr[i] = bin.charCodeAt(i);
  const blob = new Blob([arr], { type: 'application/pdf' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 500);
}

function renderResults() {
  resultsEl.innerHTML = '';
  stageState.rendered.forEach((entry, idx) => {
    const row = document.createElement('div');
    row.className = 'result-item';
    row.innerHTML = `<div><strong>${entry.filename}</strong>${entry.error ? `<div style="color:#dc2626;font-size:.84rem;">${entry.error}</div>` : ''}</div>`;

    if (!entry.error) {
      const actions = document.createElement('div');
      actions.className = 'result-actions';
      const previewBtn = document.createElement('button');
      previewBtn.textContent = 'Preview';
      previewBtn.onclick = () => { preview.srcdoc = entry.html; previewLabel.textContent = entry.filename; };

      const jsonBtn = document.createElement('button');
      jsonBtn.textContent = 'JSON';
      jsonBtn.onclick = () => downloadTextFile(`${fileStem(entry.filename)}.kreditlab.json`, JSON.stringify(entry.kreditlab_json, null, 2), 'application/json');

      const htmlBtn = document.createElement('button');
      htmlBtn.textContent = 'HTML';
      htmlBtn.onclick = () => downloadTextFile(`${fileStem(entry.filename)}.report.html`, entry.html, 'text/html');

      actions.append(previewBtn, jsonBtn, htmlBtn);
      if (entry.pdf_base64) {
        const pdfBtn = document.createElement('button');
        pdfBtn.textContent = 'PDF';
        pdfBtn.onclick = () => downloadPdfBase64(`${fileStem(entry.filename)}.report.pdf`, entry.pdf_base64);
        actions.append(pdfBtn);
      }
      row.appendChild(actions);
      if (idx === 0 && !preview.srcdoc) {
        preview.srcdoc = entry.html;
        previewLabel.textContent = entry.filename;
      }
    }

    resultsEl.appendChild(row);
  });
}

async function parseResponse(response) {
  const contentType = response.headers.get('content-type') || '';
  if (!contentType.includes('application/json')) throw new Error('Expected JSON response from API.');
  const data = await response.json();
  if (!response.ok) throw new Error(data.detail || 'Request failed');
  return data;
}

document.getElementById('runStage1Btn').addEventListener('click', async () => {
  const files = Array.from(document.getElementById('pdfFiles').files || []);
  if (!files.length) return alert('Please choose at least one PDF file.');

  setStage('stage1', 'running');
  setStage('stage2', 'pending');
  setStage('stage3', 'pending');
  document.getElementById('runStage2Btn').disabled = true;
  document.getElementById('runStage3Btn').disabled = true;
  preview.srcdoc = '';
  previewLabel.textContent = 'No file selected';
  resultsEl.innerHTML = '';

  const formData = new FormData();
  files.forEach(file => formData.append('files', file));
  try {
    setStatus('Running stage 1 with Tensorlake...');
    const response = await fetch('/stage/tensorlake', { method: 'POST', headers: authHeaders(), body: formData });
    const data = await parseResponse(response);
    stageState.extracted = data.results || [];
    renderStageErrors('Stage 1 errors', stageState.extracted);
    const failed = stageState.extracted.filter(x => x.status === 'error').length;
    if (failed === stageState.extracted.length) throw new Error(`All files failed in stage 1. ${collectStageErrors(stageState.extracted).join(' | ')}`);
    setStage('stage1', failed ? 'error' : 'success');
    setStatus(`Stage 1 completed. Success: ${stageState.extracted.length - failed}, Failed: ${failed}. Click Proceed for Stage 2.`, !!failed);
    document.getElementById('runStage2Btn').disabled = false;
  } catch (err) {
    setStage('stage1', 'error');
    setStatus(`Stage 1 failed: ${err.message}`, true);
  }
});

document.getElementById('runStage2Btn').addEventListener('click', async () => {
  const items = stageState.extracted.filter(x => x.status === 'success').map(x => ({ filename: x.filename, extraction_result: x.extraction_result }));
  if (!items.length) return alert('No successful stage 1 data found.');

  setStage('stage2', 'running');
  try {
    setStatus('Running stage 2 API transform using Sonnet 4.6...');
    const response = await fetch('/stage/transform', {
      method: 'POST',
      headers: authHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ items }),
    });
    const data = await parseResponse(response);
    stageState.transformed = data.results || [];
    renderStageErrors('Stage 2 errors', stageState.transformed);
    const failed = stageState.transformed.filter(x => x.status === 'error').length;
    if (failed === stageState.transformed.length) throw new Error(`All files failed in stage 2. ${collectStageErrors(stageState.transformed).join(' | ')}`);
    setStage('stage2', failed ? 'error' : 'success');
    setStatus(`Stage 2 completed. Success: ${stageState.transformed.length - failed}, Failed: ${failed}. Click Proceed for Stage 3.`, !!failed);
    document.getElementById('runStage3Btn').disabled = false;
  } catch (err) {
    setStage('stage2', 'error');
    setStatus(`Stage 2 failed: ${err.message}`, true);
  }
});

document.getElementById('runStage3Btn').addEventListener('click', async () => {
  const items = stageState.transformed.filter(x => x.status === 'success').map(x => ({ filename: x.filename, kreditlab_json: x.kreditlab_json }));
  if (!items.length) return alert('No successful stage 2 data found.');

  setStage('stage3', 'running');
  try {
    setStatus('Rendering HTML in stage 3...');
    const response = await fetch('/stage/render', {
      method: 'POST',
      headers: authHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ items, include_pdf: document.getElementById('includePdf').checked }),
    });
    const data = await parseResponse(response);
    stageState.rendered = data.results || [];
    renderStageErrors('Stage 3 errors', stageState.rendered);
    const failed = stageState.rendered.filter(x => x.status === 'error').length;
    setStage('stage3', failed ? 'error' : 'success');
    renderResults();
    setStatus(`Stage 3 completed. Success: ${stageState.rendered.length - failed}, Failed: ${failed}.`, !!failed);
  } catch (err) {
    setStage('stage3', 'error');
    setStatus(`Stage 3 failed: ${err.message}`, true);
  }
});
</script>
</body>
</html>
