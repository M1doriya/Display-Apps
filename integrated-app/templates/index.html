<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Display-Apps Staged Pipeline</title>
  <style>
    :root { --bg:#f3f6fb; --card:#fff; --text:#0f172a; --muted:#64748b; --primary:#2563eb; --success:#16a34a; --danger:#dc2626; --border:#e2e8f0; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: Inter, "Segoe UI", Arial, sans-serif; background:var(--bg); color:var(--text); padding:24px; }
    .layout { max-width:1200px; margin:0 auto; display:grid; gap:18px; grid-template-columns:380px 1fr; align-items:start; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:18px; }
    .input, .token-input { width:100%; border:1px solid var(--border); border-radius:10px; padding:10px; margin-bottom:10px; }
    .btn { width:100%; border:none; border-radius:10px; color:#fff; font-weight:600; padding:10px; cursor:pointer; margin-top:8px; background:linear-gradient(135deg,#2563eb,#1d4ed8); }
    .btn.secondary { background:#334155; }
    .btn:disabled { opacity:.55; cursor:not-allowed; }
    .status { margin-top:10px; min-height:20px; font-size:.9rem; }
    .status.success{ color:var(--success);} .status.error{color:var(--danger);}
    .stage-list { display:grid; gap:8px; margin:12px 0; }
    .stage { border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-size:.88rem; display:flex; justify-content:space-between; }
    .stage .pill { padding:2px 8px; border-radius:999px; background:#e2e8f0; }
    .pill.success { background:#dcfce7; color:#166534; }
    .pill.error { background:#fee2e2; color:#991b1b; }
    .pill.running { background:#dbeafe; color:#1d4ed8; }
    .result-item{ border:1px solid var(--border); border-radius:10px; padding:10px; margin-top:8px; background:#f8fafc; }
    .result-actions{ display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
    .result-actions button{ border:1px solid #cbd5e1; background:#fff; border-radius:8px; padding:6px 8px; cursor:pointer; }
    iframe { width:100%; min-height:760px; border:1px solid var(--border); border-radius:12px; background:#fff; }
    @media (max-width:1024px){ .layout{ grid-template-columns:1fr; } iframe{ min-height:500px; } }
  </style>
</head>
<body>
<div class="layout">
  <section class="card">
    <h2 style="margin-top:0;">3-Stage PDF Analysis</h2>
    <p style="margin-top:0;color:#64748b;">Run Tensorlake first, then click proceed for API transform, then proceed for HTML rendering.</p>

    <label for="token">Bearer token (optional)</label>
    <input id="token" class="token-input" placeholder="Paste APP_TOKEN if required" />

    <label for="pdfFiles">Choose PDF files</label>
    <input id="pdfFiles" class="input" type="file" accept="application/pdf" multiple />
    <label><input id="includePdf" type="checkbox" /> Include generated PDF output</label>

    <div class="stage-list">
      <div class="stage"><span>1) Tensorlake extraction</span><span id="stage1" class="pill">pending</span></div>
      <div class="stage"><span>2) API transform (Sonnet)</span><span id="stage2" class="pill">pending</span></div>
      <div class="stage"><span>3) HTML rendering</span><span id="stage3" class="pill">pending</span></div>
    </div>

    <button id="runStage1Btn" class="btn">Start Stage 1 (Tensorlake)</button>
    <button id="runStage2Btn" class="btn secondary" disabled>Proceed Stage 2 (API Transform)</button>
    <button id="runStage3Btn" class="btn secondary" disabled>Proceed Stage 3 (HTML Render)</button>

    <div id="status" class="status"></div>
    <div id="results"></div>
  </section>

  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center; margin-bottom:10px;">
      <h3 style="margin:0;">HTML Preview</h3>
      <span id="previewLabel" class="pill">No file selected</span>
    </div>
    <iframe id="preview"></iframe>
  </section>
</div>

<script>
const statusEl = document.getElementById('status');
const preview = document.getElementById('preview');
const resultsEl = document.getElementById('results');
const previewLabel = document.getElementById('previewLabel');

const stageState = {
  extracted: [],
  transformed: [],
  rendered: []
};

function collectStageErrors(items) {
  return (items || [])
    .filter(item => item.status === 'error')
    .map(item => `${item.filename || 'unknown file'}: ${item.error || 'Unknown error'}`);
}

function renderStageErrors(title, items) {
  const errors = collectStageErrors(items);
  if (!errors.length) {
    return;
  }

  const row = document.createElement('div');
  row.className = 'result-item';
  row.innerHTML = `<div><strong>${title}</strong></div>`;

  const list = document.createElement('ul');
  list.style.margin = '8px 0 0 18px';
  list.style.padding = '0';
  errors.forEach((errorLine) => {
    const li = document.createElement('li');
    li.style.color = '#dc2626';
    li.style.fontSize = '.84rem';
    li.textContent = errorLine;
    list.appendChild(li);
  });

  row.appendChild(list);
  resultsEl.prepend(row);
}

function authHeaders(extra={}) {
  const token = document.getElementById('token').value.trim();
  return token ? { ...extra, Authorization: `Bearer ${token}` } : extra;
}

function setStage(id, state) {
  const el = document.getElementById(id);
  el.className = `pill ${state}`;
  el.textContent = state;
}

function setStatus(message, isError=false) {
  statusEl.className = `status ${isError ? 'error' : 'success'}`;
  statusEl.textContent = message;
}

function fileStem(filename) { return filename.replace(/\.[^.]+$/, '') || 'report'; }
function downloadTextFile(filename, content, mime) { const blob = new Blob([content], { type:mime }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
function downloadPdfBase64(filename, base64String) { const bytes = Uint8Array.from(atob(base64String), c => c.charCodeAt(0)); const blob = new Blob([bytes], { type:'application/pdf' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

function renderResults() {
  resultsEl.innerHTML = '';
  stageState.rendered.forEach((entry, idx) => {
    const row = document.createElement('div');
    row.className = 'result-item';
    row.innerHTML = `<div><strong>${entry.filename}</strong>${entry.error ? `<div style="color:#dc2626;font-size:.84rem;">${entry.error}</div>` : ''}</div>`;

    if (!entry.error) {
      const actions = document.createElement('div');
      actions.className = 'result-actions';
      const previewBtn = document.createElement('button'); previewBtn.textContent = 'Preview'; previewBtn.onclick = () => { preview.srcdoc = entry.html; previewLabel.textContent = entry.filename; };
      const jsonBtn = document.createElement('button'); jsonBtn.textContent = 'JSON'; jsonBtn.onclick = () => downloadTextFile(`${fileStem(entry.filename)}.kreditlab.json`, JSON.stringify(entry.kreditlab_json, null, 2), 'application/json');
      const htmlBtn = document.createElement('button'); htmlBtn.textContent = 'HTML'; htmlBtn.onclick = () => downloadTextFile(`${fileStem(entry.filename)}.report.html`, entry.html, 'text/html');
      actions.append(previewBtn, jsonBtn, htmlBtn);
      if (entry.pdf_base64) { const pdfBtn = document.createElement('button'); pdfBtn.textContent = 'PDF'; pdfBtn.onclick = () => downloadPdfBase64(`${fileStem(entry.filename)}.report.pdf`, entry.pdf_base64); actions.append(pdfBtn); }
      row.appendChild(actions);
      if (idx === 0 && !preview.srcdoc) { preview.srcdoc = entry.html; previewLabel.textContent = entry.filename; }
    }
    resultsEl.appendChild(row);
  });
}

async function parseResponse(response) {
  const contentType = response.headers.get('content-type') || '';
  if (!contentType.includes('application/json')) throw new Error('Expected JSON response from API.');
  const data = await response.json();
  if (!response.ok) throw new Error(data.detail || 'Request failed');
  return data;
}

document.getElementById('runStage1Btn').addEventListener('click', async () => {
  const files = Array.from(document.getElementById('pdfFiles').files || []);
  if (!files.length) return alert('Please choose at least one PDF file.');

  setStage('stage1', 'running'); setStage('stage2', 'pending'); setStage('stage3', 'pending');
  document.getElementById('runStage2Btn').disabled = true;
  document.getElementById('runStage3Btn').disabled = true;
  preview.srcdoc = ''; previewLabel.textContent = 'No file selected';
  resultsEl.innerHTML = '';

  const formData = new FormData(); files.forEach(file => formData.append('files', file));
  try {
    setStatus('Running stage 1 with Tensorlake...');
    const response = await fetch('/stage/tensorlake', { method:'POST', headers: authHeaders(), body: formData });
    const data = await parseResponse(response);
    stageState.extracted = data.results || [];
    renderStageErrors('Stage 1 errors', stageState.extracted);
    const failed = stageState.extracted.filter(x => x.status === 'error').length;
    if (failed === stageState.extracted.length) {
      const details = collectStageErrors(stageState.extracted).join(' | ');
      throw new Error(`All files failed in stage 1. ${details}`);
    }
    setStage('stage1', failed ? 'error' : 'success');
    setStatus(`Stage 1 completed. Success: ${stageState.extracted.length - failed}, Failed: ${failed}. Click Proceed for Stage 2.`, !!failed);
    document.getElementById('runStage2Btn').disabled = false;
  } catch (err) {
    setStage('stage1', 'error');
    setStatus(`Stage 1 failed: ${err.message}`, true);
  }
});

document.getElementById('runStage2Btn').addEventListener('click', async () => {
  const items = stageState.extracted.filter(x => x.status === 'success').map(x => ({ filename:x.filename, extraction_result:x.extraction_result }));
  if (!items.length) return alert('No successful stage 1 data found.');

  setStage('stage2', 'running');
  try {
    setStatus('Running stage 2 API transform using Sonnet model...');
    const response = await fetch('/stage/transform', {
      method:'POST',
      headers: authHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ items })
    });
    const data = await parseResponse(response);
    stageState.transformed = data.results || [];
    renderStageErrors('Stage 2 errors', stageState.transformed);
    const failed = stageState.transformed.filter(x => x.status === 'error').length;
    if (failed === stageState.transformed.length) {
      const details = collectStageErrors(stageState.transformed).join(' | ');
      throw new Error(`All files failed in stage 2. ${details}`);
    }
    setStage('stage2', failed ? 'error' : 'success');
    setStatus(`Stage 2 completed. Success: ${stageState.transformed.length - failed}, Failed: ${failed}. Click Proceed for Stage 3.`, !!failed);
    document.getElementById('runStage3Btn').disabled = false;
  } catch (err) {
    setStage('stage2', 'error');
    setStatus(`Stage 2 failed: ${err.message}`, true);
  }
});

document.getElementById('runStage3Btn').addEventListener('click', async () => {
  const items = stageState.transformed.filter(x => x.status === 'success').map(x => ({ filename:x.filename, kreditlab_json:x.kreditlab_json }));
  if (!items.length) return alert('No successful stage 2 data found.');

  setStage('stage3', 'running');
  try {
    setStatus('Rendering HTML in stage 3...');
    const response = await fetch('/stage/render', {
      method:'POST',
      headers: authHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ items, include_pdf: document.getElementById('includePdf').checked })
    });
    const data = await parseResponse(response);
    stageState.rendered = data.results || [];
    renderStageErrors('Stage 3 errors', stageState.rendered);
    const failed = stageState.rendered.filter(x => x.status === 'error').length;
    setStage('stage3', failed ? 'error' : 'success');
    renderResults();
    setStatus(`Stage 3 completed. Success: ${stageState.rendered.length - failed}, Failed: ${failed}.`, !!failed);
  } catch (err) {
    setStage('stage3', 'error');
    setStatus(`Stage 3 failed: ${err.message}`, true);
  }
});
</script>
</body>
</html>
