<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KreditLab â€¢ Statement Pipeline</title>

  <!-- Professional editorial theme aligned with kreditlab.my: bold hierarchy, minimal palette, crisp spacing -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Neutral editorial palette */
      --bg:#fbfbfc;
      --surface:#ffffff;
      --surface-2:#f6f7f9;
      --surface-3:#f0f2f5;

      --text:#0b0f16;
      --muted:#5b6472;
      --muted-2:#778196;

      --border:#e6e8ee;
      --shadow: 0 20px 48px rgba(11, 15, 22, 0.08);
      --shadow-soft: 0 12px 28px rgba(11, 15, 22, 0.06);

      --primary:#0b0f16;   /* kreditlab.my reads as black-forward */
      --accent:#0ea5e9;    /* subtle highlight for focus/links */
      --success:#0f766e;
      --danger:#b91c1c;
      --warning:#b45309;

      --ring: rgba(14,165,233,.22);

      --radius-xl: 22px;
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 10px;

      --gridline: rgba(11, 15, 22, 0.04);
    }

    [data-theme="dark"]{
      --bg:#070a10;
      --surface:#0b0f16;
      --surface-2:#0f1622;
      --surface-3:#121b2a;

      --text:#f3f4f6;
      --muted:#a6b0c0;
      --muted-2:#8e9aaf;

      --border:#1f2a3a;
      --shadow: 0 26px 70px rgba(0,0,0,.55);
      --shadow-soft: 0 18px 48px rgba(0,0,0,.38);

      --primary:#f3f4f6;
      --accent:#38bdf8;
      --ring: rgba(56,189,248,.25);

      --gridline: rgba(243,244,246, 0.05);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(circle at 85% -20%, rgba(14,165,233,.10), transparent 55%),
        radial-gradient(circle at 10% 0%, rgba(11,15,22,.06), transparent 52%),
        var(--bg);
      line-height: 1.5;
    }

    a{ color:var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    /* Page shell */
    .shell{
      max-width: 1180px;
      margin: 0 auto;
      padding: 18px 16px 56px;
    }

    /* Header */
    .header{
      position: sticky;
      top: 14px;
      z-index: 10;
      padding: 10px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--surface) 92%, transparent);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-soft);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 240px;
    }
    .brand img{
      width: clamp(46px, 4.2vw, 58px);
      height: clamp(46px, 4.2vw, 58px);
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--surface);
      padding: 5px;
      object-fit: contain;
    }
    .brand .name{
      display:flex;
      flex-direction:column;
      gap: 2px;
      line-height: 1.1;
    }
    .brand .name strong{
      font-size: .95rem;
      letter-spacing: .01em;
      font-weight: 850;
    }
    .brand .name span{
      font-size: .78rem;
      color: var(--muted);
      font-weight: 600;
    }

    .nav{
      display:flex;
      gap: 14px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:center;
    }
    .nav a{
      font-size: .84rem;
      color: var(--muted);
      font-weight: 750;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
    }
    .nav a:hover{
      border-color: var(--border);
      background: var(--surface);
      text-decoration:none;
      color: var(--text);
    }

    .header-actions{
      display:flex;
      align-items:center;
      gap: 10px;
    }

    .chip{
      border:1px solid var(--border);
      background: var(--surface);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: .82rem;
      font-weight: 850;
      color: var(--muted);
      white-space: nowrap;
    }

    .theme-btn{
      border:1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 900;
      letter-spacing: .01em;
    }

    /* Hero */
    .hero{
      margin-top: 18px;
      padding: 34px 26px;
      border-radius: var(--radius-xl);
      border: 1px solid var(--border);
      background:
        linear-gradient(180deg, color-mix(in srgb, var(--surface) 96%, transparent), var(--surface)),
        repeating-linear-gradient(90deg, transparent 0, transparent 23px, var(--gridline) 24px),
        repeating-linear-gradient(0deg, transparent 0, transparent 23px, var(--gridline) 24px);
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }
    .hero:after{
      content:"";
      position:absolute;
      inset:-45% -30%;
      background:
        radial-gradient(circle at 25% 30%, rgba(14,165,233,.16), transparent 62%),
        radial-gradient(circle at 70% 60%, rgba(14,165,233,.10), transparent 58%);
      transform: rotate(-7deg);
      z-index: -1;
    }
    .hero .kicker{
      font-size: .82rem;
      font-weight: 900;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .hero h1{
      margin: 10px 0 0;
      font-size: clamp(1.85rem, 2.8vw, 2.55rem);
      line-height: 1.08;
      letter-spacing: -0.03em;
    }
    .hero p{
      margin: 12px 0 0;
      max-width: 78ch;
      color: var(--muted);
      font-size: 1rem;
      font-weight: 560;
    }
    .hero .submeta{
      margin-top: 16px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }
    .badge{
      border: 1px solid var(--border);
      background: var(--surface);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: .82rem;
      font-weight: 850;
      color: var(--muted);
    }

    /* Layout */
    .layout{
      display:grid;
      grid-template-columns: minmax(0, 1.35fr) minmax(0, .65fr);
      gap: 18px;
      margin-top: 18px;
      align-items:start;
    }

    .card{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      overflow:hidden;
    }
    .card .card-inner{ padding: 22px; }

    .section-head{
      display:flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 14px;
      margin-bottom: 14px;
    }
    .section-head h2{
      margin: 0;
      font-size: 1.05rem;
      letter-spacing: -0.01em;
      font-weight: 900;
    }
    .section-head p{
      margin: 8px 0 0;
      color: var(--muted);
      font-size: .92rem;
      font-weight: 600;
      max-width: 72ch;
    }

    /* Form */
    .form-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 10px;
    }

    .field label{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 10px;
      font-size: .84rem;
      color: var(--muted);
      font-weight: 850;
      letter-spacing: .01em;
    }
    .field label .hint{
      font-weight: 650;
      color: var(--muted-2);
      font-size: .8rem;
    }

    .input, .token-input{
      width: 100%;
      margin-top: 8px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: var(--surface-2);
      color: var(--text);
      padding: 12px 12px;
      outline:none;
      transition: border-color .15s ease, box-shadow .15s ease, transform .08s ease;
    }
    .input:focus, .token-input:focus{
      border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
      box-shadow: 0 0 0 4px var(--ring);
    }

    .options-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
      margin-top: 2px;
    }
    .check{
      display:flex;
      align-items:center;
      gap: 10px;
      font-size: .9rem;
      color: var(--muted);
      font-weight: 700;
      user-select:none;
    }
    .check input{ transform: translateY(1px); }

    /* Stage list */
    .stage-list{
      margin-top: 12px;
      display:grid;
      gap: 10px;
    }
    .stage{
      border: 1px solid var(--border);
      background: linear-gradient(180deg, var(--surface), var(--surface-2));
      border-radius: var(--radius-lg);
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .stage-left{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
    }
    .stage-num{
      width: 30px; height: 30px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface);
      display:grid; place-items:center;
      font-weight: 950;
      font-size: .86rem;
      color: var(--muted);
      flex: 0 0 auto;
    }
    .stage-title{
      font-weight: 900;
      font-size: .93rem;
      letter-spacing: -0.01em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .stage-desc{
      display:block;
      margin-top: 2px;
      color: var(--muted);
      font-weight: 650;
      font-size: .82rem;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      font-size: .78rem;
      font-weight: 950;
      letter-spacing: .12em;
      text-transform: uppercase;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--muted);
      flex: 0 0 auto;
    }
    .pill.success{ border-color: color-mix(in srgb, var(--success) 40%, var(--border)); color: var(--success); }
    .pill.error{ border-color: color-mix(in srgb, var(--danger) 40%, var(--border)); color: var(--danger); }
    .pill.running{ border-color: color-mix(in srgb, var(--accent) 48%, var(--border)); color: var(--accent); }

    /* Buttons */
    .btnrow{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .btn{
      width: 100%;
      border: 1px solid transparent;
      border-radius: 999px;
      padding: 12px 14px;
      cursor:pointer;
      font-weight: 950;
      font-size: .92rem;
      letter-spacing: .01em;
      transition: transform .07s ease, box-shadow .15s ease, opacity .2s ease, border-color .15s ease, background .15s ease;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: var(--primary);
      color: color-mix(in srgb, var(--primary) 8%, #fff);
      box-shadow: 0 16px 36px rgba(11, 15, 22, 0.18);
    }
    [data-theme="dark"] .btn.primary{
      color: #0b0f16;
      box-shadow: 0 16px 36px rgba(0,0,0,0.45);
    }
    .btn.secondary{
      background: transparent;
      border-color: var(--border);
      color: var(--text);
    }
    .btn.secondary:hover{ background: var(--surface-2); }
    .btn:disabled{ opacity: .52; cursor: not-allowed; box-shadow:none; }

    /* Status block */
    .status{
      margin-top: 14px;
      min-height: 20px;
      font-size: .9rem;
      color: var(--muted);
      font-weight: 750;
    }
    .status.success{ color: var(--success); }
    .status.error{ color: var(--danger); }

    /* Results */
    .results-head{
      margin-top: 18px;
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 12px;
    }
    .results-title{
      margin: 0;
      font-size: .82rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .14em;
      font-weight: 950;
    }

    .result-item{
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 12px;
      margin-top: 10px;
      background: var(--surface-2);
    }
    .result-actions{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .result-actions button{
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      border-radius: 999px;
      padding: 7px 10px;
      cursor:pointer;
      font-weight: 900;
      font-size: .82rem;
    }
    .result-actions button:hover{ background: var(--surface-2); }

    /* Aside */
    .aside .card-inner{ padding: 22px; }
    .aside h3{
      margin: 0;
      font-size: 1rem;
      letter-spacing: -0.01em;
      font-weight: 950;
    }
    .aside p{
      margin: 8px 0 14px;
      color: var(--muted);
      font-size: .9rem;
      font-weight: 620;
    }

    .kpi-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin: 14px 0 16px;
    }
    .kpi{
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 12px;
      background: linear-gradient(180deg, var(--surface), var(--surface-2));
    }
    .kpi span{
      display:block;
      font-size: .74rem;
      text-transform: uppercase;
      letter-spacing: .14em;
      font-weight: 950;
      color: var(--muted);
    }
    .kpi strong{
      display:block;
      margin-top: 6px;
      font-size: .98rem;
      letter-spacing: -0.01em;
      font-weight: 900;
    }

    .tips{
      margin: 0;
      padding-left: 18px;
      color: var(--muted);
      font-size: .88rem;
      line-height: 1.55;
      font-weight: 600;
    }
    .tips li{ margin: 6px 0; }

    /* Footer */
    .footer{
      margin-top: 18px;
      padding: 18px 4px 0;
      color: var(--muted);
      font-size: .86rem;
      font-weight: 650;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
    }
    .footer .fine{
      opacity: .95;
    }

    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
      .header{ position: static; border-radius: var(--radius-xl); padding: 12px; }
      .nav{ display:none; } /* keep it clean on mobile */
    }
  </style>
</head>

<body>
  <div class="shell">
    <header class="header">
      <div class="brand">
        <img id="brandLogo" src="/assets/KreditLab-light.png" alt="KreditLab logo" />
        <div class="name">
          <strong>KreditLab Pipeline</strong>
          <span>Clarity before capital â€¢ internal tooling</span>
        </div>
      </div>

      <nav class="nav" aria-label="Primary">
        <a href="#pipeline">Pipeline</a>
        <a href="#resultsSection">Results</a>
        <a href="#help">Notes</a>
      </nav>

      <div class="header-actions">
        <div class="chip">Interactive â€¢ Dark/Light</div>
        <button id="themeToggle" class="theme-btn" type="button">ðŸŒ™ Dark</button>
      </div>
    </header>

    <section class="hero" aria-label="Intro">
      <div class="kicker">Statement processing</div>
      <h1>Turn raw PDFs into bankâ€‘ready structure â€” in three controlled stages.</h1>
      <p>
        Upload one or more PDF financial statements, run extraction + transformation, then generate deliverables
        (JSON, HTML, and optional PDF). The interface is intentionally minimal, mirroring KreditLabâ€™s editorial clarity.
      </p>

      <div class="submeta">
        <div class="badge">Stage 1 â†’ Extraction</div>
        <div class="badge">Stage 2 â†’ Transform</div>
        <div class="badge">Stage 3 â†’ Render</div>
      </div>
    </section>

    <main class="layout" id="pipeline">
      <section class="card" aria-label="Pipeline controls">
        <div class="card-inner">
          <div class="section-head">
            <div>
              <h2>Pipeline controls</h2>
              <p>Run stages sequentially. Stages 2 and 3 unlock only after prior success outputs.</p>
            </div>
          </div>

          <div class="form-grid">
            <div class="field">
              <label for="token">
                Bearer token (optional)
                <span class="hint">Only if your API requires auth</span>
              </label>
              <input id="token" class="token-input" placeholder="Paste APP_TOKEN if required" />
            </div>

            <div class="field">
              <label for="pdfFiles">
                PDF files
                <span class="hint">Multiâ€‘select supported</span>
              </label>
              <input id="pdfFiles" class="input" type="file" accept="application/pdf" multiple />
            </div>

            <div class="options-row">
              <label class="check">
                <input id="includePdf" type="checkbox" />
                Include generated PDF output (Stage 3)
              </label>
            </div>
          </div>

          <div class="stage-list" aria-label="Stage status">
            <div class="stage">
              <div class="stage-left">
                <div class="stage-num">1</div>
                <div style="min-width:0">
                  <div class="stage-title">Tensorlake extraction</div>
                  <span class="stage-desc">PDF â†’ extraction_result</span>
                </div>
              </div>
              <span id="stage1" class="pill">pending</span>
            </div>

            <div class="stage">
              <div class="stage-left">
                <div class="stage-num">2</div>
                <div style="min-width:0">
                  <div class="stage-title">API transform</div>
                  <span class="stage-desc">extraction_result â†’ kreditlab_json</span>
                </div>
              </div>
              <span id="stage2" class="pill">pending</span>
            </div>

            <div class="stage">
              <div class="stage-left">
                <div class="stage-num">3</div>
                <div style="min-width:0">
                  <div class="stage-title">HTML rendering</div>
                  <span class="stage-desc">kreditlab_json â†’ HTML (+ optional PDF)</span>
                </div>
              </div>
              <span id="stage3" class="pill">pending</span>
            </div>
          </div>

          <div class="btnrow">
            <button id="runStage1Btn" class="btn primary">Start Stage 1</button>
            <button id="runStage2Btn" class="btn secondary" disabled>Proceed to Stage 2</button>
            <button id="runStage3Btn" class="btn secondary" disabled>Proceed to Stage 3</button>
          </div>

          <div id="status" class="status" aria-live="polite"></div>

          <div class="results-head" id="resultsSection">
            <div class="results-title">Results</div>
          </div>
          <div id="results"></div>
        </div>
      </section>

      <aside class="card aside" id="help" aria-label="Notes">
        <div class="card-inner">
          <h3>Operating notes</h3>
          <p>Designed for predictable runs: clear state, surfaced errors, and perâ€‘file downloads.</p>

          <div class="kpi-grid">
            <div class="kpi"><span>Inputs</span><strong>PDF financial statements</strong></div>
            <div class="kpi"><span>Outputs</span><strong>JSON â€¢ HTML â€¢ PDF (optional)</strong></div>
            <div class="kpi"><span>Behavior</span><strong>Batch runs â€¢ per-file artifacts</strong></div>
          </div>

          <ul class="tips">
            <li>Stage 2 uses only files that succeeded in Stage 1.</li>
            <li>Stage 3 uses only files that succeeded in Stage 2.</li>
            <li>Errors are grouped by stage to speed up debugging.</li>
          </ul>
        </div>
      </aside>
    </main>

    <div class="footer" aria-label="Footer">
      <div class="fine">Clarity Before Capital â€¢ Internal tool</div>
      <div class="fine">Tip: best viewed in Chrome / Edge for consistent PDF downloads.</div>
    </div>
  </div>

<script>
/* =========
   Theme
   ========= */
const statusEl = document.getElementById('status');
const resultsEl = document.getElementById('results');
const themeToggle = document.getElementById('themeToggle');
const brandLogo = document.getElementById('brandLogo');

const stageState = { extracted: [], transformed: [], rendered: [] };

function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  const dark = theme === 'dark';
  brandLogo.src = dark ? '/assets/KreditLab-dark.png' : '/assets/KreditLab-light.png';
  themeToggle.textContent = dark ? 'â˜€ï¸ Light' : 'ðŸŒ™ Dark';
  localStorage.setItem('kreditlab-theme', theme);
}

const savedTheme = localStorage.getItem('kreditlab-theme') || 'light';
applyTheme(savedTheme);
themeToggle.addEventListener('click', () => applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));

/* =========
   Helpers
   ========= */
function collectStageErrors(items) {
  return (items || []).filter(item => item.status === 'error').map(item => `${item.filename || 'unknown file'}: ${item.error || 'Unknown error'}`);
}

function renderStageErrors(title, items) {
  const errors = collectStageErrors(items);
  if (!errors.length) return;

  const row = document.createElement('div');
  row.className = 'result-item';
  row.innerHTML = `<div><strong>${title}</strong></div>`;

  const list = document.createElement('ul');
  list.style.margin = '10px 0 0 18px';
  list.style.padding = '0';
  errors.forEach((errorLine) => {
    const li = document.createElement('li');
    li.style.color = getComputedStyle(document.documentElement).getPropertyValue('--danger') || '#b91c1c';
    li.style.fontSize = '.86rem';
    li.textContent = errorLine;
    list.appendChild(li);
  });

  row.appendChild(list);
  resultsEl.prepend(row);
}

function authHeaders(extra = {}) {
  const token = document.getElementById('token').value.trim();
  return token ? { ...extra, Authorization: `Bearer ${token}` } : extra;
}

function setStage(id, state) {
  const el = document.getElementById(id);
  el.className = `pill ${state}`;
  el.textContent = state;
}

function setStatus(message, isError = false) {
  statusEl.className = `status ${isError ? 'error' : 'success'}`;
  statusEl.textContent = message;
}

function fileStem(filename) { return filename.replace(/\.[^.]+$/, '') || 'report'; }

function downloadTextFile(filename, content, mime) {
  const blob = new Blob([content], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 500);
}

function downloadPdfBase64(filename, base64) {
  const bin = atob(base64);
  const arr = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i += 1) arr[i] = bin.charCodeAt(i);
  const blob = new Blob([arr], { type: 'application/pdf' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 500);
}

function renderResults() {
  resultsEl.innerHTML = '';
  stageState.rendered.forEach((entry) => {
    const row = document.createElement('div');
    row.className = 'result-item';
    row.innerHTML = `<div><strong>${entry.filename}</strong>${entry.error ? `<div style="color:var(--danger);font-size:.86rem;margin-top:6px">${entry.error}</div>` : ''}</div>`;

    if (!entry.error) {
      const actions = document.createElement('div');
      actions.className = 'result-actions';

      const jsonBtn = document.createElement('button');
      jsonBtn.textContent = 'Download JSON';
      jsonBtn.onclick = () => downloadTextFile(`${fileStem(entry.filename)}.kreditlab.json`, JSON.stringify(entry.kreditlab_json, null, 2), 'application/json');

      const htmlBtn = document.createElement('button');
      htmlBtn.textContent = 'Download HTML';
      htmlBtn.onclick = () => downloadTextFile(`${fileStem(entry.filename)}.report.html`, entry.html, 'text/html');

      actions.append(jsonBtn, htmlBtn);

      if (entry.pdf_base64) {
        const pdfBtn = document.createElement('button');
        pdfBtn.textContent = 'Download PDF';
        pdfBtn.onclick = () => downloadPdfBase64(`${fileStem(entry.filename)}.report.pdf`, entry.pdf_base64);
        actions.append(pdfBtn);
      }

      row.appendChild(actions);
    }

    resultsEl.appendChild(row);
  });
}

async function parseResponse(response) {
  const contentType = response.headers.get('content-type') || '';
  if (!contentType.includes('application/json')) throw new Error('Expected JSON response from API.');
  const data = await response.json();
  if (!response.ok) throw new Error(data.detail || 'Request failed');
  return data;
}

/* =========
   Stage wiring
   ========= */
document.getElementById('runStage1Btn').addEventListener('click', async () => {
  const files = Array.from(document.getElementById('pdfFiles').files || []);
  if (!files.length) return alert('Please choose at least one PDF file.');

  setStage('stage1', 'running');
  setStage('stage2', 'pending');
  setStage('stage3', 'pending');
  document.getElementById('runStage2Btn').disabled = true;
  document.getElementById('runStage3Btn').disabled = true;
  resultsEl.innerHTML = '';

  const formData = new FormData();
  files.forEach(file => formData.append('files', file));

  try {
    setStatus('Running Stage 1 (Tensorlake extraction)â€¦');
    const response = await fetch('/stage/tensorlake', { method: 'POST', headers: authHeaders(), body: formData });
    const data = await parseResponse(response);

    stageState.extracted = data.results || [];
    renderStageErrors('Stage 1 errors', stageState.extracted);

    const failed = stageState.extracted.filter(x => x.status === 'error').length;
    if (failed === stageState.extracted.length) throw new Error(`All files failed in Stage 1. ${collectStageErrors(stageState.extracted).join(' | ')}`);

    setStage('stage1', failed ? 'error' : 'success');
    setStatus(`Stage 1 completed. Success: ${stageState.extracted.length - failed}, Failed: ${failed}. Proceed to Stage 2.`, !!failed);
    document.getElementById('runStage2Btn').disabled = false;
  } catch (err) {
    setStage('stage1', 'error');
    setStatus(`Stage 1 failed: ${err.message}`, true);
  }
});

document.getElementById('runStage2Btn').addEventListener('click', async () => {
  const items = stageState.extracted.filter(x => x.status === 'success')
    .map(x => ({ filename: x.filename, extraction_result: x.extraction_result }));
  if (!items.length) return alert('No successful Stage 1 data found.');

  setStage('stage2', 'running');

  try {
    setStatus('Running Stage 2 (API transform)â€¦');
    const response = await fetch('/stage/transform', {
      method: 'POST',
      headers: authHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ items }),
    });
    const data = await parseResponse(response);

    stageState.transformed = data.results || [];
    renderStageErrors('Stage 2 errors', stageState.transformed);

    const failed = stageState.transformed.filter(x => x.status === 'error').length;
    if (failed === stageState.transformed.length) throw new Error(`All files failed in Stage 2. ${collectStageErrors(stageState.transformed).join(' | ')}`);

    setStage('stage2', failed ? 'error' : 'success');
    setStatus(`Stage 2 completed. Success: ${stageState.transformed.length - failed}, Failed: ${failed}. Proceed to Stage 3.`, !!failed);
    document.getElementById('runStage3Btn').disabled = false;
  } catch (err) {
    setStage('stage2', 'error');
    setStatus(`Stage 2 failed: ${err.message}`, true);
  }
});

document.getElementById('runStage3Btn').addEventListener('click', async () => {
  const items = stageState.transformed.filter(x => x.status === 'success')
    .map(x => ({ filename: x.filename, kreditlab_json: x.kreditlab_json }));
  if (!items.length) return alert('No successful Stage 2 data found.');

  setStage('stage3', 'running');

  try {
    setStatus('Running Stage 3 (HTML render)â€¦');
    const response = await fetch('/stage/render', {
      method: 'POST',
      headers: authHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ items, include_pdf: document.getElementById('includePdf').checked }),
    });
    const data = await parseResponse(response);

    stageState.rendered = data.results || [];
    renderStageErrors('Stage 3 errors', stageState.rendered);

    const failed = stageState.rendered.filter(x => x.status === 'error').length;
    setStage('stage3', failed ? 'error' : 'success');

    renderResults();
    setStatus(`Stage 3 completed. Success: ${stageState.rendered.length - failed}, Failed: ${failed}.`, !!failed);
  } catch (err) {
    setStage('stage3', 'error');
    setStatus(`Stage 3 failed: ${err.message}`, true);
  }
});
</script>
</body>
</html>
