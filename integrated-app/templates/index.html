<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KreditLab Pipeline App</title>
  <style>
    :root {
      --bg: #eff4fb;
      --surface: #ffffff;
      --surface-soft: #f5f9ff;
      --text: #0e1a31;
      --muted: #64748b;
      --primary: #083a8f;
      --primary-2: #1d74dd;
      --accent: #18b6d9;
      --success: #138a59;
      --danger: #c52e4b;
      --warning: #bf7a1c;
      --border: #dbe6f7;
      --ring: rgba(29, 116, 221, 0.2);
      --shadow: 0 22px 40px rgba(8, 25, 58, 0.1);
      --gridline: rgba(29, 116, 221, 0.08);
    }

    [data-theme="dark"] {
      --bg: #040b18;
      --surface: #0d172a;
      --surface-soft: #12213b;
      --text: #e6efff;
      --muted: #8fa7ca;
      --primary: #4a9bff;
      --primary-2: #24b8db;
      --accent: #61dcff;
      --success: #2fcf84;
      --danger: #ff6180;
      --warning: #ffc361;
      --border: #1f355d;
      --ring: rgba(97, 220, 255, 0.22);
      --shadow: 0 28px 50px rgba(1, 8, 22, 0.65);
      --gridline: rgba(97, 220, 255, 0.08);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", "Manrope", "Segoe UI", Arial, sans-serif;
      color: var(--text);
      min-height: 100vh;
      background:
        linear-gradient(180deg, rgba(255,255,255,.5), rgba(255,255,255,0)),
        radial-gradient(circle at 95% 0%, color-mix(in srgb, var(--accent) 20%, transparent), transparent 40%),
        radial-gradient(circle at 0% 0%, color-mix(in srgb, var(--primary) 18%, transparent), transparent 36%),
        var(--bg);
      padding: 24px;
    }

    .shell { max-width: 1240px; margin: 0 auto; }

    .app-header {
      border: 1px solid var(--border);
      background:
        linear-gradient(110deg, color-mix(in srgb, var(--surface) 88%, var(--accent) 12%), color-mix(in srgb, var(--surface) 92%, var(--primary) 8%));
      border-radius: 20px;
      padding: 20px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      box-shadow: var(--shadow);
      margin-bottom: 18px;
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }

    .app-header::after {
      content: "";
      position: absolute;
      inset: 0;
      background-image: linear-gradient(90deg, var(--gridline) 1px, transparent 1px), linear-gradient(180deg, var(--gridline) 1px, transparent 1px);
      background-size: 32px 32px;
      mask-image: linear-gradient(120deg, transparent 15%, rgba(0,0,0,.8) 55%, transparent 100%);
      z-index: -1;
    }

    .brand { display: flex; align-items: center; gap: 14px; }

    .brand img {
      height: 44px;
      border-radius: 10px;
      padding: 5px 8px;
      background: rgba(255,255,255,.9);
      border: 1px solid rgba(255,255,255,.35);
    }

    .brand-text h1 { margin: 0; font-size: 1.24rem; letter-spacing: .01em; }
    .brand-text p { margin: 5px 0 0; font-size: .92rem; color: var(--muted); max-width: 760px; }

    .theme-btn {
      border: 1px solid var(--border);
      color: var(--text);
      background: color-mix(in srgb, var(--surface) 78%, var(--accent) 22%);
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      white-space: nowrap;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
      gap: 18px;
      align-items: start;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
    }

    .controls-card { padding: 22px; }
    .aside-card { padding: 20px; }

    .title { margin: 0; font-size: 1.1rem; }
    .subtitle { margin: 8px 0 18px; color: var(--muted); font-size: .92rem; line-height: 1.45; }

    .field { margin-bottom: 14px; }
    .field label { font-size: .88rem; color: var(--muted); font-weight: 600; }

    .input, .token-input {
      width: 100%;
      margin-top: 7px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--surface-soft);
      color: var(--text);
      padding: 11px 12px;
      outline: none;
      transition: border-color .18s ease, box-shadow .18s ease;
    }

    .input:focus, .token-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--ring);
    }

    .check-wrap {
      margin: 10px 0 16px;
      color: var(--muted);
      font-size: .9rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }

    .stage-list { display: grid; gap: 9px; margin: 14px 0 16px; }
    .stage {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 11px 12px;
      font-size: .9rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(145deg, var(--surface-soft), color-mix(in srgb, var(--surface-soft) 84%, var(--accent) 16%));
      font-weight: 600;
    }

    .pill {
      padding: 4px 9px;
      border-radius: 999px;
      color: var(--muted);
      background: color-mix(in srgb, var(--surface-soft) 72%, var(--border) 28%);
      text-transform: capitalize;
      font-size: .78rem;
      font-weight: 700;
      letter-spacing: .01em;
    }

    .pill.success { background: color-mix(in srgb, var(--success) 22%, var(--surface)); color: var(--success); }
    .pill.error { background: color-mix(in srgb, var(--danger) 24%, var(--surface)); color: var(--danger); }
    .pill.running { background: color-mix(in srgb, var(--primary) 24%, var(--surface)); color: var(--primary); }

    .btn {
      width: 100%;
      border: none;
      border-radius: 12px;
      padding: 12px;
      margin-top: 8px;
      cursor: pointer;
      color: #fff;
      font-weight: 700;
      font-size: .92rem;
      background: linear-gradient(128deg, var(--primary), var(--primary-2));
      box-shadow: 0 12px 26px color-mix(in srgb, var(--primary) 32%, transparent);
    }

    .btn.secondary {
      background: linear-gradient(128deg, #223a63, #2b548a);
      box-shadow: none;
    }

    .btn:disabled { opacity: .52; cursor: not-allowed; }

    .status { margin-top: 14px; min-height: 20px; font-size: .9rem; color: var(--muted); font-weight: 700; }
    .status.success { color: var(--success); }
    .status.error { color: var(--danger); }

    .results-title {
      margin: 18px 0 8px;
      font-size: .78rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .1em;
      font-weight: 800;
    }

    .result-item {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 11px;
      margin-top: 8px;
      background: var(--surface-soft);
    }

    .result-actions { display: flex; gap: 7px; flex-wrap: wrap; margin-top: 8px; }
    .result-actions button {
      border: 1px solid var(--border);
      background: linear-gradient(145deg, var(--surface), var(--surface-soft));
      color: var(--text);
      border-radius: 9px;
      padding: 6px 10px;
      cursor: pointer;
      font-weight: 700;
      font-size: .82rem;
    }

    .aside-title { margin: 0 0 8px; font-size: .98rem; }
    .aside-copy { margin: 0 0 16px; color: var(--muted); font-size: .88rem; line-height: 1.45; }

    .metric-grid { display: grid; gap: 10px; margin-bottom: 16px; }
    .metric {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 11px;
      background: linear-gradient(145deg, color-mix(in srgb, var(--surface-soft) 86%, var(--accent) 14%), var(--surface-soft));
    }
    .metric span { display: block; color: var(--muted); font-size: .76rem; text-transform: uppercase; letter-spacing: .08em; font-weight: 800; }
    .metric strong { font-size: 1rem; margin-top: 4px; display: block; }

    .tips {
      margin: 0;
      padding-left: 18px;
      color: var(--muted);
      font-size: .86rem;
      line-height: 1.5;
    }

    @media (max-width: 1050px) {
      .layout { grid-template-columns: 1fr; }
      .aside-card { order: -1; }
    }

    @media (max-width: 760px) {
      body { padding: 16px; }
      .app-header { padding: 16px; flex-wrap: wrap; }
      .brand-text h1 { font-size: 1.12rem; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="app-header">
      <div class="brand">
        <img id="brandLogo" src="/assets/KreditLab-light.png" alt="KreditLab logo" />
        <div class="brand-text">
          <h1>KreditLab Financial Statement Workspace</h1>
          <p>Enterprise-style processing workspace for extraction, AI transformation, and polished financial report output.</p>
        </div>
      </div>
      <button id="themeToggle" class="theme-btn" type="button">ðŸŒ™ Dark mode</button>
    </header>

    <div class="layout">
      <section class="card controls-card">
        <h2 class="title">Pipeline Controls</h2>
        <p class="subtitle">Upload one or more PDF statements and process them through each pipeline stage. Outputs are available for immediate download after rendering.</p>

        <div class="field">
          <label for="token">Bearer token (optional)</label>
          <input id="token" class="token-input" placeholder="Paste APP_TOKEN if required" />
        </div>

        <div class="field">
          <label for="pdfFiles">Choose PDF files</label>
          <input id="pdfFiles" class="input" type="file" accept="application/pdf" multiple />
        </div>

        <label class="check-wrap"><input id="includePdf" type="checkbox" /> Include generated PDF output</label>

        <div class="stage-list">
          <div class="stage"><span>1) Tensorlake extraction</span><span id="stage1" class="pill">pending</span></div>
          <div class="stage"><span>2) API transform (Sonnet 4.6)</span><span id="stage2" class="pill">pending</span></div>
          <div class="stage"><span>3) HTML rendering</span><span id="stage3" class="pill">pending</span></div>
        </div>

        <button id="runStage1Btn" class="btn">Start Stage 1 (Tensorlake)</button>
        <button id="runStage2Btn" class="btn secondary" disabled>Proceed Stage 2 (API Transform)</button>
        <button id="runStage3Btn" class="btn secondary" disabled>Proceed Stage 3 (HTML Render)</button>

        <div id="status" class="status"></div>
        <div class="results-title">Results</div>
        <div id="results"></div>
      </section>

      <aside class="card aside-card">
        <h3 class="aside-title">Workspace Overview</h3>
        <p class="aside-copy">Designed with a professional KreditLab-inspired visual language: confident blues, clean surfaces, and concise progress signaling.</p>

        <div class="metric-grid">
          <div class="metric"><span>Stage 1</span><strong>Extraction Engine</strong></div>
          <div class="metric"><span>Stage 2</span><strong>Structured AI Transform</strong></div>
          <div class="metric"><span>Stage 3</span><strong>Report Generation</strong></div>
        </div>

        <ul class="tips">
          <li>Upload multiple statements to process them in one run.</li>
          <li>Use dark mode for low-light analyst workflows.</li>
          <li>Download JSON, HTML, and optional PDF deliverables per file.</li>
        </ul>
      </aside>
    </div>
  </div>

<script>
const statusEl = document.getElementById('status');
const resultsEl = document.getElementById('results');
const themeToggle = document.getElementById('themeToggle');
const brandLogo = document.getElementById('brandLogo');

const stageState = { extracted: [], transformed: [], rendered: [] };

function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  const dark = theme === 'dark';
  brandLogo.src = dark ? '/assets/KreditLab-dark.png' : '/assets/KreditLab-light.png';
  themeToggle.textContent = dark ? 'â˜€ï¸ Light mode' : 'ðŸŒ™ Dark mode';
  localStorage.setItem('kreditlab-theme', theme);
}

const savedTheme = localStorage.getItem('kreditlab-theme') || 'light';
applyTheme(savedTheme);
themeToggle.addEventListener('click', () => applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));

function collectStageErrors(items) {
  return (items || []).filter(item => item.status === 'error').map(item => `${item.filename || 'unknown file'}: ${item.error || 'Unknown error'}`);
}

function renderStageErrors(title, items) {
  const errors = collectStageErrors(items);
  if (!errors.length) return;
  const row = document.createElement('div');
  row.className = 'result-item';
  row.innerHTML = `<div><strong>${title}</strong></div>`;

  const list = document.createElement('ul');
  list.style.margin = '8px 0 0 18px';
  list.style.padding = '0';
  errors.forEach((errorLine) => {
    const li = document.createElement('li');
    li.style.color = '#dc2626';
    li.style.fontSize = '.84rem';
    li.textContent = errorLine;
    list.appendChild(li);
  });

  row.appendChild(list);
  resultsEl.prepend(row);
}

function authHeaders(extra = {}) {
  const token = document.getElementById('token').value.trim();
  return token ? { ...extra, Authorization: `Bearer ${token}` } : extra;
}

function setStage(id, state) {
  const el = document.getElementById(id);
  el.className = `pill ${state}`;
  el.textContent = state;
}

function setStatus(message, isError = false) {
  statusEl.className = `status ${isError ? 'error' : 'success'}`;
  statusEl.textContent = message;
}

function fileStem(filename) { return filename.replace(/\.[^.]+$/, '') || 'report'; }

function downloadTextFile(filename, content, mime) {
  const blob = new Blob([content], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 500);
}

function downloadPdfBase64(filename, base64) {
  const bin = atob(base64);
  const arr = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i += 1) arr[i] = bin.charCodeAt(i);
  const blob = new Blob([arr], { type: 'application/pdf' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 500);
}

function renderResults() {
  resultsEl.innerHTML = '';
  stageState.rendered.forEach((entry) => {
    const row = document.createElement('div');
    row.className = 'result-item';
    row.innerHTML = `<div><strong>${entry.filename}</strong>${entry.error ? `<div style="color:#dc2626;font-size:.84rem;">${entry.error}</div>` : ''}</div>`;

    if (!entry.error) {
      const actions = document.createElement('div');
      actions.className = 'result-actions';
      const jsonBtn = document.createElement('button');
      jsonBtn.textContent = 'JSON';
      jsonBtn.onclick = () => downloadTextFile(`${fileStem(entry.filename)}.kreditlab.json`, JSON.stringify(entry.kreditlab_json, null, 2), 'application/json');

      const htmlBtn = document.createElement('button');
      htmlBtn.textContent = 'HTML';
      htmlBtn.onclick = () => downloadTextFile(`${fileStem(entry.filename)}.report.html`, entry.html, 'text/html');

      actions.append(jsonBtn, htmlBtn);
      if (entry.pdf_base64) {
        const pdfBtn = document.createElement('button');
        pdfBtn.textContent = 'PDF';
        pdfBtn.onclick = () => downloadPdfBase64(`${fileStem(entry.filename)}.report.pdf`, entry.pdf_base64);
        actions.append(pdfBtn);
      }
      row.appendChild(actions);
    }

    resultsEl.appendChild(row);
  });
}

async function parseResponse(response) {
  const contentType = response.headers.get('content-type') || '';
  if (!contentType.includes('application/json')) throw new Error('Expected JSON response from API.');
  const data = await response.json();
  if (!response.ok) throw new Error(data.detail || 'Request failed');
  return data;
}

document.getElementById('runStage1Btn').addEventListener('click', async () => {
  const files = Array.from(document.getElementById('pdfFiles').files || []);
  if (!files.length) return alert('Please choose at least one PDF file.');

  setStage('stage1', 'running');
  setStage('stage2', 'pending');
  setStage('stage3', 'pending');
  document.getElementById('runStage2Btn').disabled = true;
  document.getElementById('runStage3Btn').disabled = true;
  resultsEl.innerHTML = '';

  const formData = new FormData();
  files.forEach(file => formData.append('files', file));
  try {
    setStatus('Running stage 1 with Tensorlake...');
    const response = await fetch('/stage/tensorlake', { method: 'POST', headers: authHeaders(), body: formData });
    const data = await parseResponse(response);
    stageState.extracted = data.results || [];
    renderStageErrors('Stage 1 errors', stageState.extracted);
    const failed = stageState.extracted.filter(x => x.status === 'error').length;
    if (failed === stageState.extracted.length) throw new Error(`All files failed in stage 1. ${collectStageErrors(stageState.extracted).join(' | ')}`);
    setStage('stage1', failed ? 'error' : 'success');
    setStatus(`Stage 1 completed. Success: ${stageState.extracted.length - failed}, Failed: ${failed}. Click Proceed for Stage 2.`, !!failed);
    document.getElementById('runStage2Btn').disabled = false;
  } catch (err) {
    setStage('stage1', 'error');
    setStatus(`Stage 1 failed: ${err.message}`, true);
  }
});

document.getElementById('runStage2Btn').addEventListener('click', async () => {
  const items = stageState.extracted.filter(x => x.status === 'success').map(x => ({ filename: x.filename, extraction_result: x.extraction_result }));
  if (!items.length) return alert('No successful stage 1 data found.');

  setStage('stage2', 'running');
  try {
    setStatus('Running stage 2 API transform using Sonnet 4.6...');
    const response = await fetch('/stage/transform', {
      method: 'POST',
      headers: authHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ items }),
    });
    const data = await parseResponse(response);
    stageState.transformed = data.results || [];
    renderStageErrors('Stage 2 errors', stageState.transformed);
    const failed = stageState.transformed.filter(x => x.status === 'error').length;
    if (failed === stageState.transformed.length) throw new Error(`All files failed in stage 2. ${collectStageErrors(stageState.transformed).join(' | ')}`);
    setStage('stage2', failed ? 'error' : 'success');
    setStatus(`Stage 2 completed. Success: ${stageState.transformed.length - failed}, Failed: ${failed}. Click Proceed for Stage 3.`, !!failed);
    document.getElementById('runStage3Btn').disabled = false;
  } catch (err) {
    setStage('stage2', 'error');
    setStatus(`Stage 2 failed: ${err.message}`, true);
  }
});

document.getElementById('runStage3Btn').addEventListener('click', async () => {
  const items = stageState.transformed.filter(x => x.status === 'success').map(x => ({ filename: x.filename, kreditlab_json: x.kreditlab_json }));
  if (!items.length) return alert('No successful stage 2 data found.');

  setStage('stage3', 'running');
  try {
    setStatus('Rendering HTML in stage 3...');
    const response = await fetch('/stage/render', {
      method: 'POST',
      headers: authHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ items, include_pdf: document.getElementById('includePdf').checked }),
    });
    const data = await parseResponse(response);
    stageState.rendered = data.results || [];
    renderStageErrors('Stage 3 errors', stageState.rendered);
    const failed = stageState.rendered.filter(x => x.status === 'error').length;
    setStage('stage3', failed ? 'error' : 'success');
    renderResults();
    setStatus(`Stage 3 completed. Success: ${stageState.rendered.length - failed}, Failed: ${failed}.`, !!failed);
  } catch (err) {
    setStage('stage3', 'error');
    setStatus(`Stage 3 failed: ${err.message}`, true);
  }
});
</script>
</body>
</html>
